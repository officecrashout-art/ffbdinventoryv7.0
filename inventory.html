<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

  <style>
    :root { --primary: #1abc9c; --bg-dark: #f4f7f6; --bg-card: #ffffff; --border: #dee2e6; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg-dark); margin: 0; }
    .inventory-container { padding: 20px; max-width: 1400px; margin: 0 auto; }
    .action-bar { display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
    .table-responsive { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow-x: auto; }
    .inventory-table { width: 100%; border-collapse: collapse; }
    .inventory-table th { background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid var(--border); }
    .inventory-table td { padding: 12px 15px; border-bottom: 1px solid var(--border); }
    .product-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border); }
    .modal { display: none; position: fixed; z-index: 1000; inset: 0; background: rgba(0,0,0,0.6); overflow-y: auto; }
    .modal-content { background: var(--bg-card); margin: 2% auto; padding: 25px; width: 90%; max-width: 1000px; border-radius: 15px; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; }
    .btn { padding: 10px 20px; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; border: none; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border); }
    #processingOverlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 2000; align-items: center; justify-content: center; flex-direction: column; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="inventory-container">
  <div class="action-bar">
    <h1 style="margin:0; font-size: 1.5rem; color: var(--primary);">Inventory Items</h1>
    <div style="display:flex; gap:10px;">
      <input type="text" id="invSearch" placeholder="Search product..." onkeyup="invFilter()" style="width:250px;">
      <button class="btn btn-primary" onclick="invOpenModal()">+ Add Product</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="inventory-table">
      <thead>
        <tr><th>Image</th><th>Item ID</th><th>Item Name</th><th>Brand</th><th>Category</th><th>Size</th><th>Stock</th><th>Actions</th></tr>
      </thead>
      <tbody id="invTableBody"></tbody>
    </table>
  </div>
</div>

<div id="invModal" class="modal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 id="modalTitle" style="margin:0;">Add New Product</h2>
      <i class="fas fa-times" style="cursor:pointer;" onclick="invCloseModal()"></i>
    </div>
    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
      <div style="flex: 0 0 200px; text-align: center;">
        <div id="imgPreview" style="width:200px; height:200px; border:2px dashed #ccc; border-radius:10px; display:flex; align-items:center; justify-content:center; margin-bottom:10px; overflow:hidden;">No Image</div>
        <input type="file" id="invImgInput" accept="image/*" style="display:none;" onchange="invPreviewImage(this)">
        <button class="btn btn-outline" onclick="document.getElementById('invImgInput').click()" style="width:100%;">Upload Photo</button>
        <input type="hidden" id="invImgUrl">
      </div>
      <div style="flex: 1; min-width: 300px;">
        <div class="form-grid">
          <div><label>Product Name</label><input type="text" id="invName"></div>
          <div><label>Brand <i class="fas fa-plus-circle" onclick="invAddNew('Brands')"></i></label><select id="invBrand"></select></div>
          <div><label>Category <i class="fas fa-plus-circle" onclick="invAddNew('Item Category')"></i></label><select id="invCategory"></select></div>
          <div><label>Subcategory <i class="fas fa-plus-circle" onclick="invAddNew('Item Subcategory')"></i></label><select id="invSubcat"></select></div>
          <div><label>Reorder Level</label><input type="number" id="invReorder" value="5"></div>
        </div>
        <h4 style="margin: 20px 0 10px 0;">Sizes & Opening Stock</h4>
        <div id="variantContainer"></div>
        <button class="btn btn-outline" style="margin-top:10px;" onclick="invAddVariant()">+ Add Size</button>
      </div>
    </div>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:30px; border-top: 1px solid #eee; padding-top: 20px;">
      <button class="btn btn-outline" onclick="invCloseModal()">Discard</button>
      <button class="btn btn-primary" onclick="invSave()">Save Product</button>
    </div>
  </div>
</div>

<div id="processingOverlay"><div class="spinner"></div><p style="margin-top:15px;">Processing...</p></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
  let inventoryData = { items: [], brands: [], categories: [], subcategories: [] };

  document.addEventListener('DOMContentLoaded', invLoad);

  function invLoad() {
    $('#processingOverlay').css('display', 'flex');
    google.script.run.withSuccessHandler(data => {
      inventoryData = data;
      renderTable(data.items);
      populateSelect('#invBrand', data.brands);
      populateSelect('#invCategory', data.categories);
      populateSelect('#invSubcat', data.subcategories);
      $('#invBrand, #invCategory, #invSubcat').select2({ dropdownParent: $('#invModal'), width: '100%' });
      $('#processingOverlay').hide();
    }).itemGetInventoryData();
  }

  function populateSelect(selector, list) {
    const el = $(selector).empty().append('<option value="">Select...</option>');
    list.forEach(item => el.append(new Option(item, item)));
  }

  function renderTable(items) {
  const tbody = document.getElementById('invTableBody');
  tbody.innerHTML = items.map(item => {
    const imgUrl = item['Image URL'];
    const imageTag = imgUrl ? 
      `<img src="${imgUrl}" class="product-img" onerror="this.src='https://placehold.co/50x50?text=Error'">` : 
      `<div class="no-img-placeholder"><i class="fas fa-image"></i></div>`;

    // Convert comma-separated string into visual pills
    const sizes = (item['Size'] || 'N/A').split(',').map(s => 
      `<span style="background:#e8f4f2; color:#1abc9c; padding:2px 8px; border-radius:12px; font-size:11px; font-weight:600; margin-right:4px; border:1px solid #1abc9c;">${s.trim()}</span>`
    ).join('');

    return `
      <tr>
        <td>${imageTag}</td>
        <td style="font-family:monospace; font-weight:bold; color:#666;">${item['Item ID']}</td>
        <td><b>${item['Item Name']}</b></td>
        <td>${item['Brands']}</td>
        <td>${item['Item Category']}</td>
        <td>${sizes}</td> <td style="font-weight:bold;">${item['Remaining QTY']}</td>
        <td>
          <button class="btn btn-outline" onclick="invDeleteItem('${item['Item ID']}')">
            <i class="fas fa-trash" style="color:var(--danger);"></i>
          </button>
        </td>
      </tr>`;
  }).join('');
}
  /**
 * Fixed Quick Add function with error handling to prevent infinite loading[cite: 15].
 */
function invAddNew(type) {
  const val = prompt("Enter new " + type + ":");
  if (!val) return;

  $('#processingOverlay').css('display', 'flex'); // Show spinner

  google.script.run
    .withFailureHandler(err => {
      $('#processingOverlay').hide(); // Hide spinner on error
      alert("Error adding " + type + ": " + err.message);
    })
    .withSuccessHandler(res => {
      $('#processingOverlay').hide(); // Hide spinner on success
      if (res && res.success) {
        alert(type + " added successfully!");
        invLoad(); // Refresh the dropdown lists
      }
    })
    .itemAddNewDimension(type, val);
}

  function invPreviewImage(input) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = e => {
        $('#imgPreview').html(`<img src="${e.target.result}" style="width:100%; height:100%; object-fit:cover;">`);
        $('#processingOverlay').css('display', 'flex');
        google.script.run.withSuccessHandler(url => { $('#invImgUrl').val(url); $('#processingOverlay').hide(); }).itemUploadImage(e.target.result, input.files[0].name);
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function invAddVariant(data = null) {
    const id = 'var-' + Date.now();
    $('#variantContainer').append(`
      <div id="${id}" style="display:flex; gap:10px; margin-bottom:8px;">
        <input type="text" class="v-size" placeholder="Size" value="${data ? data.Size : ''}">
        <input type="number" class="v-stock" placeholder="Stock" value="${data ? data.Opening : 0}">
        <button class="btn btn-outline" onclick="this.parentElement.remove()">X</button>
      </div>`);
  }

  function invOpenModal() { $('#invModal').show(); $('#variantContainer').empty(); invAddVariant(); }
  function invCloseModal() { $('#invModal').hide(); }

  function invSave() {
    const data = {
      name: $('#invName').val(), brand: $('#invBrand').val(), category: $('#invCategory').val(),
      subcategory: $('#invSubcat').val(), reorderLevel: $('#invReorder').val(),
      imageUrl: $('#invImgUrl').val(), variants: []
    };
    $('#variantContainer > div').each(function() {
      data.variants.push({ size: $(this).find('.v-size').val(), openingStock: $(this).find('.v-stock').val(), id: "AUTO" });
    });
    $('#processingOverlay').css('display', 'flex');
    google.script.run.withSuccessHandler(() => location.reload()).itemSaveProductWithVariants(data);
  }

  function invDeleteItem(id) { if(confirm("Delete?")) google.script.run.withSuccessHandler(() => location.reload()).itemDeleteItem(id); }
  function invFilter() {
    const val = $('#invSearch').val().toLowerCase();
    renderTable(inventoryData.items.filter(i => i['Item Name'].toLowerCase().includes(val)));
  }
</script>
</body>
</html>