<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Purchase Orders | Fashion Fizz BD</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  
  <style>
    :root {
      --primary: #1abc9c; --secondary: #3498db; --danger: #e74c3c;
      --success: #2ecc71; --bg-card: var(--bg-card); /* From Template */
    }
    
    body { font-family: 'Poppins', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; }
    
    .purchase-container { padding: 20px; max-width: 1400px; margin: 0 auto; }
    
    /* Responsive Header & Action Bar */
    .header-section { margin-bottom: 20px; }
    .action-bar { 
      display: flex; justify-content: space-between; align-items: center; 
      gap: 15px; flex-wrap: wrap; background: var(--bg-card); padding: 15px;
      border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow);
    }

    /* Table & Card View for Mobile */
    .table-responsive { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow-x: auto; }
    .purchase-table { width: 100%; border-collapse: collapse; min-width: 800px; }
    .purchase-table th { background: var(--bg-hover); color: var(--primary); padding: 15px; text-align: left; font-size: 0.85rem; border-bottom: 2px solid var(--border); }
    .purchase-table td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }

    /* Modal Styling */
    .modal { display: none; position: fixed; z-index: 10000; inset: 0; background: rgba(0,0,0,0.7); overflow-y: auto; backdrop-filter: blur(5px); }
    .modal-content { background: var(--bg-card); margin: 2% auto; padding: 25px; width: 95%; max-width: 1200px; border-radius: 15px; border: 1px solid var(--border); }
    
    .form-grid { 
      display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
      gap: 15px; margin-bottom: 20px; padding: 20px; background: var(--bg-dark); border-radius: 10px; 
    }
    
    label { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 5px; }
    input, select { background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border); padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; }

    /* Items Table Mobile Handling */
    .items-table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; }
    .items-table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    .items-table th { background: var(--bg-hover); padding: 10px; font-size: 0.75rem; }

    /* Buttons */
    .btn { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }

    /* Processing Overlay */
    #poProcessingOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 20000; align-items: center; justify-content: center; flex-direction: column; color: white; }
    .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    @media (max-width: 600px) {
      .purchase-table { min-width: 100%; }
      .purchase-table thead { display: none; }
      .purchase-table tr { display: block; margin-bottom: 10px; border: 1px solid var(--border); }
      .purchase-table td { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: none; }
      .purchase-table td::before { content: attr(data-label); font-weight: bold; color: var(--primary); }
    }
  </style>
</head>
<body>

<div class="purchase-container">
  <div class="header-section">
    <h1 style="color:var(--primary); margin:0;">Stock Purchase Management</h1>
  </div>

  <div class="action-bar">
    <button class="btn btn-primary" onclick="poOpenNewPOModal()">
      <i class="fas fa-plus-circle"></i> New Purchase
    </button>
    <div style="display:flex; gap:10px; flex:1; max-width:400px;">
      <input type="text" id="poSearchInput" placeholder="Search Supplier or PO ID..." onkeyup="poApplySearch()">
    </div>
  </div>

  <div class="table-responsive" style="margin-top:20px;">
    <table class="purchase-table">
      <thead>
        <tr>
          <th>Date</th><th>PO ID</th><th>Supplier</th><th>Amount</th><th>Balance</th><th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="poTableBody"></tbody>
    </table>
  </div>
</div>

<div id="poNewPOModal" class="modal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 id="poModalTitle" style="color:var(--primary); margin:0;">Create Purchase Order</h2>
      <i class="fas fa-times" style="cursor:pointer; font-size:1.5rem;" onclick="poCloseNewPOModal()"></i>
    </div>

    <div class="form-grid">
      <div>
        <label>PURCHASE ID</label>
        <div style="display:flex; gap:5px;">
          <input type="text" id="poPOID" readonly style="background:var(--bg-hover);">
          <button id="btnGenID" class="btn btn-primary" style="padding:5px 15px;" onclick="poGeneratePOID()">Gen</button>
        </div>
      </div>
      <div><label>PURCHASE DATE</label><input type="text" id="poPODate" class="date-picker"></div>
      <div><label>SUPPLIER</label><select id="poSupplierName"></select></div>
      <div><label>BILL / INVOICE #</label><input type="text" id="poBillNum"></div>
    </div>

    <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
       <h4 style="margin:0;">Itemized Details</h4>
       <button class="btn btn-outline" onclick="poAddItemRow()"><i class="fas fa-plus"></i> Add Line</button>
    </div>

    <div class="items-table-wrapper">
      <table class="items-table">
        <thead>
          <tr>
            <th>Product Name (Select)</th>
            <th width="100">Brand</th>
            <th width="80">Size</th>
            <th width="100">Qty</th>
            <th width="120">Unit Cost</th>
            <th width="120">Total (Incl. Tax)</th>
            <th width="50"></th>
          </tr>
        </thead>
        <tbody id="poItemsTableBody"></tbody>
      </table>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:15px; margin-top:25px;">
      <button class="btn btn-outline" onclick="poCloseNewPOModal()">Discard</button>
      <button class="btn btn-primary" onclick="poSave()">Confirm Purchase</button>
    </div>
  </div>
</div>

<div id="poProcessingOverlay">
  <div class="spinner"></div>
  <p style="margin-top:15px;">Updating Stock & Records...</p>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
  let poAllPOs = [], poSuppliers = [], poItems = [];

  document.addEventListener('DOMContentLoaded', () => {
    flatpickr(".date-picker", { dateFormat: "Y-m-d", defaultDate: "today" });
    poInitialLoad();
  });

  function poInitialLoad() {
    poShowLoading();
    google.script.run
      .withFailureHandler(err => {
        alert("Startup Error: " + err.message);
        poHideLoading();
      })
      .withSuccessHandler(data => {
        poSuppliers = data.suppliers;
        poItems = data.items;
        poAllPOs = data.pos;
        poRenderTable(poAllPOs);
        
        const supSelect = $('#poSupplierName');
        supSelect.empty().append('<option value="">Select Supplier</option>');
        poSuppliers.forEach(s => supSelect.append(new Option(s['Supplier Name'], s['Supplier ID'])));
        supSelect.select2({ dropdownParent: $('#poNewPOModal'), width: '100%' });
        
        poHideLoading();
      }).getPurchaseStartupData();
  }

  function poRenderTable(data) {
    document.getElementById('poTableBody').innerHTML = data.map(po => `
      <tr>
        <td data-label="Date">${po.Date}</td>
        <td data-label="PO ID"><b>${po['PO ID']}</b></td>
        <td data-label="Supplier">${po['Supplier Name']}</td>
        <td data-label="Amount">৳${parseFloat(po['Total Amount']).toLocaleString()}</td>
        <td data-label="Balance" style="color:${po['PO Balance'] > 0 ? 'var(--danger)' : 'var(--success)'}; font-weight:bold;">
           ৳${parseFloat(po['PO Balance']).toLocaleString()}
        </td>
        <td data-label="Status">${po['PMT Status']}</td>
        <td data-label="Action">
          <button class="btn btn-outline" onclick="poViewDetails('${po['PO ID']}')"><i class="fas fa-edit"></i></button>
        </td>
      </tr>`).join('');
  }

  function poAddItemRow(data = null) {
    const rowId = data ? data['Detail ID'] : 'new-' + Date.now();
    const tr = document.createElement('tr');
    tr.id = `row-${rowId}`;
    tr.innerHTML = `
      <td>
        <select class="item-sel" onchange="poOnItemChange(this, '${rowId}')" style="width:100%">
          <option value="">Choose Item...</option>
          ${poItems.map(i => `<option value="${i['Item ID']}" 
              data-brand="${i['Brand'] || ''}" 
              data-size="${i['Size'] || ''}"
              ${data && data['Item ID'] == i['Item ID'] ? 'selected' : ''}>${i['Item Name']}</option>`).join('')}
        </select>
      </td>
      <td><input type="text" class="brand" value="${data ? (data['Brand'] || '') : ''}" readonly></td>
      <td><input type="text" class="size" value="${data ? (data['Size'] || '') : ''}" readonly></td>
      <td><input type="number" class="qty" value="${data ? data['QTY Purchased'] : 1}" oninput="poCalcTotal()"></td>
      <td><input type="number" class="cost" value="${data ? data['Unit Cost'] : 0}" step="0.01" oninput="poCalcTotal()"></td>
      <td><input type="number" class="total" value="${data ? data['Total Purchase Price'] : 0}" readonly style="font-weight:bold;"></td>
      <td><i class="fas fa-trash" style="color:var(--danger); cursor:pointer;" onclick="this.closest('tr').remove(); poCalcTotal();"></i></td>
    `;
    document.getElementById('poItemsTableBody').appendChild(tr);
    $(`#row-${rowId} .item-sel`).select2({ dropdownParent: $('#poNewPOModal'), width: '100%' });
  }

  function poOnItemChange(sel, rowId) {
    const option = sel.options[sel.selectedIndex];
    const row = document.getElementById(`row-${rowId}`);
    row.querySelector('.brand').value = option.dataset.brand || '';
    row.querySelector('.size').value = option.dataset.size || '';
    poCalcTotal();
  }

  function poCalcTotal() {
    $('#poItemsTableBody tr').each(function() {
      const qty = parseFloat($(this).find('.qty').val()) || 0;
      const cost = parseFloat($(this).find('.cost').val()) || 0;
      $(this).find('.total').val((qty * cost).toFixed(2));
    });
  }

  function poSave() {
    const items = [];
    const poId = $('#poPOID').val();
    const supId = $('#poSupplierName').val();
    
    if(!poId || !supId) return alert("Please generate ID and select Supplier.");

    $('#poItemsTableBody tr').each(function() {
      const itemId = $(this).find('.item-sel').val();
      if(itemId) {
        items.push({
          poId: poId,
          date: $('#poPODate').val(),
          supplierId: supId,
          supplierName: $('#poSupplierName option:selected').text(),
          billNum: $('#poBillNum').val(),
          itemId: itemId,
          itemName: $(this).find('.item-sel option:selected').text(),
          qty: parseFloat($(this).find('.qty').val()),
          unitCost: parseFloat($(this).find('.cost').val()),
          total: parseFloat($(this).find('.total').val())
        });
      }
    });

    if(items.length === 0) return alert("Add at least one item.");

    poShowLoading();
    google.script.run
      .withSuccessHandler(() => { 
        alert("Purchase Recorded Successfully!"); 
        location.reload(); 
      })
      .withFailureHandler(err => {
        alert("Error: " + err.message);
        poHideLoading();
      })
      .soSaveOrUpdatePO(poId, items); // Ensure this matches your gs function name
  }

  function poShowLoading() { $('#poProcessingOverlay').css('display','flex'); }
  function poHideLoading() { $('#poProcessingOverlay').hide(); }
  function poCloseNewPOModal() { $('#poNewPOModal').hide(); }
  function poOpenNewPOModal() { $('#poNewPOModal').show(); $('#poItemsTableBody').empty(); $('#btnGenID').show(); }
  function poGeneratePOID() { google.script.run.withSuccessHandler(id => $('#poPOID').val(id)).poGeneratePOID(); }
  
  function poApplySearch() {
    const term = $('#poSearchInput').val().toLowerCase();
    const filtered = poAllPOs.filter(p => 
      p['Supplier Name'].toLowerCase().includes(term) || 
      p['PO ID'].toLowerCase().includes(term)
    );
    poRenderTable(filtered);
  }
</script>
</body>
</html>