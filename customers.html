<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root { --primary: #1abc9c; --bg-dark: #f4f7f6; --bg-card: #ffffff; --border: #dee2e6; --text: #2c3e50; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg-dark); color: var(--text); margin: 0; padding: 20px; }
    .container { max-width: 1300px; margin: 0 auto; background: var(--bg-card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid var(--border); padding-bottom: 15px; }
    
    .search-box { display: flex; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
    input { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 6px; outline: none; }
    input:focus { border-color: var(--primary); }

    .table-res { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 15px; background: #f1f3f5; font-size: 0.85rem; text-transform: uppercase; color: #666; }
    td { padding: 15px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
    .badge-bal { background: #fff5f5; color: #e74c3c; border: 1px solid #feb2b2; }
    .badge-ok { background: #f0fff4; color: #38a169; border: 1px solid #9ae6b4; }

    .btn { padding: 8px 15px; border-radius: 6px; cursor: pointer; border: none; font-weight: 500; display: inline-flex; align-items: center; gap: 5px; }
    .btn-outline { background: transparent; border: 1px solid var(--border); transition: 0.2s; }
    .btn-outline:hover { background: #f8f9fa; border-color: var(--primary); color: var(--primary); }

    #loader { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.7); z-index: 100; align-items: center; justify-content: center; flex-direction: column; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2 style="margin:0; color:var(--primary);"><i class="fas fa-users"></i> Customer Directory</h2>
    <div style="font-size: 0.85rem; color: #888;">Manage profiles and payment history</div>
  </div>

  <div class="search-box">
    <i class="fas fa-search" style="align-self:center; color:#ccc;"></i>
    <input type="text" id="custSearch" placeholder="Search by Name or Phone Number (Contact)..." onkeyup="filterCustomers()">
  </div>

  <div class="table-res">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Customer Name</th>
          <th>Contact / Phone</th>
          <th>Location (City)</th>
          <th>Total Sales</th>
          <th>Balance</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="custTableBody"></tbody>
    </table>
  </div>
</div>

<div id="loader"><div class="spinner"></div><p style="margin-top:10px;">Loading Customers...</p></div>

<script>
  let allCustomers = [];

  document.addEventListener('DOMContentLoaded', loadCustomers);

  function loadCustomers() {
    document.getElementById('loader').style.display = 'flex';
    google.script.run.withSuccessHandler(data => {
      allCustomers = data;
      renderTable(data);
      document.getElementById('loader').style.display = 'none';
    }).custGetCustomers();
  }

  function renderTable(data) {
    const tbody = document.getElementById('custTableBody');
    if(data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px; color:#999;">No customers found.</td></tr>';
      return;
    }

    tbody.innerHTML = data.map(c => {
      const balance = parseFloat(c['Balance Receivable']) || 0;
      const balClass = balance > 0 ? 'badge-bal' : 'badge-ok';
      
      return `
        <tr>
          <td style="font-weight:600; color:#888;">${c['Customer ID']}</td>
          <td><b>${c['Customer Name']}</b><br><small style="color:#999;">${c['Customer Address'] || ''}</small></td>
          <td>${c['Customer Contact'] || 'N/A'}</td>
          <td>${c['City'] || 'N/A'}</td>
          <td>৳${(parseFloat(c['Total Sales']) || 0).toLocaleString()}</td>
          <td><span class="badge ${balClass}">৳${balance.toLocaleString()}</span></td>
          <td>
            <button class="btn btn-outline" onclick="viewHistory('${c['Customer ID']}')">
              <i class="fas fa-history"></i> History
            </button>
          </td>
        </tr>`;
    }).join('');
  }

  /**
   * SEARCH LOGIC: Handles Name and Phone (Contact).
   */
  function filterCustomers() {
    const term = document.getElementById('custSearch').value.toLowerCase();
    const filtered = allCustomers.filter(c => 
      c['Customer Name'].toLowerCase().includes(term) || 
      (c['Customer Contact'] && c['Customer Contact'].toString().includes(term))
    );
    renderTable(filtered);
  }

  function viewHistory(id) {
    alert("History for " + id + " is under development. This will show a detailed popup of all Sales Orders.");
  }
</script>
</body>
</html>